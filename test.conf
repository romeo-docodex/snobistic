# =========================
# snobistic.ro — Django + mod_wsgi (TLS)
# =========================
<VirtualHost *:443>
    ServerName snobistic.ro
    ServerAlias www.snobistic.ro
    ServerAdmin office@snobistic.ro
    DocumentRoot /var/www/html

    # HTTP/2
    Protocols h2 http/1.1

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/snobistic_error.log
    CustomLog ${APACHE_LOG_DIR}/snobistic_access.log combined
    LogLevel warn

    # === SSL (Let's Encrypt) ===
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/snobistic.ro/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/snobistic.ro/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # === WSGI (Django) ===
    # settings.py: venv = /snobistic/env, project = /snobistic/snobistic
    WSGIDaemonProcess snobistic python-home=/snobistic/env python-path=/snobistic/snobistic
    WSGIProcessGroup snobistic
    WSGIScriptAlias / /snobistic/snobistic/snobistic/wsgi.py

    # Nu expune directoare sensibile - doar folderul cu wsgi.py
    <Directory /snobistic/snobistic/snobistic>
        Require all granted
        Options FollowSymLinks
    </Directory>

    # === STATIC (from STATIC_ROOT) ===
    # settings.py -> STATIC_ROOT = /snobistic/snobistic/staticfiles
    Alias /static/ /snobistic/snobistic/staticfiles/
    <Directory /snobistic/snobistic/staticfiles/>
        Require all granted
        Options FollowSymLinks

        # Cache control (hashed vs non-hashed)
        <IfModule mod_expires.c>
            ExpiresActive On
            # hashed (min 8 hex chars)
            <FilesMatch "\.[0-9a-fA-F]{8,}\.(css|js|png|webp|jpg|jpeg|svg|gif|woff2)$">
                ExpiresDefault "access plus 1 year"
            </FilesMatch>
            # fallback
            <FilesMatch "\.(css|js|png|webp|jpg|jpeg|svg|gif|woff2)$">
                ExpiresDefault "access plus 30 days"
            </FilesMatch>
        </IfModule>

        <IfModule mod_headers.c>
            <FilesMatch "\.[0-9a-fA-F]{8,}\.(css|js|png|webp|jpg|jpeg|svg|gif|woff2)$">
                Header set Cache-Control "public, max-age=31536000, immutable"
            </FilesMatch>
            <FilesMatch "\.(css|js|png|webp|jpg|jpeg|svg|gif|woff2)$">
                Header set Cache-Control "public, max-age=2592000, must-revalidate"
            </FilesMatch>
            FileETag MTime Size
            Header merge Vary "Accept-Encoding"
        </IfModule>
    </Directory>

    # === MEDIA (from MEDIA_ROOT) ===
    Alias /media/ /snobistic/snobistic/media/
    <Directory /snobistic/snobistic/media/>
        Require all granted
        Options FollowSymLinks

        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpeg    "access plus 30 days"
            ExpiresByType image/png     "access plus 30 days"
            ExpiresByType image/webp    "access plus 30 days"
            ExpiresByType image/gif     "access plus 30 days"
            ExpiresByType image/svg+xml "access plus 30 days"
            ExpiresByType video/mp4     "access plus 30 days"
        </IfModule>

        <IfModule mod_headers.c>
            Header set Cache-Control "public, max-age=2592000, must-revalidate"
            FileETag MTime Size
            Header merge Vary "Accept-Encoding"
        </IfModule>
    </Directory>

    # === Compression (gzip) ===
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/css application/javascript application/json application/xml text/plain image/svg+xml
    </IfModule>

    # === Security headers (safe defaults) ===
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "DENY"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        # Activează HSTS după ce confirmi full-HTTPS:
        # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    </IfModule>
</VirtualHost>

# =========================
# HTTP -> HTTPS redirect
# =========================
<VirtualHost *:80>
    ServerName snobistic.ro
    ServerAlias www.snobistic.ro

    ErrorLog ${APACHE_LOG_DIR}/snobistic_http_error.log
    CustomLog ${APACHE_LOG_DIR}/snobistic_http_access.log combined

    RewriteEngine On
    RewriteRule ^ https://snobistic.ro%{REQUEST_URI} [R=301,L]
</VirtualHost>
