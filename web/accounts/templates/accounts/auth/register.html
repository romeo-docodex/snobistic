{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Creează-ți cont pe Snobistic{% endblock %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<section class="flat-spacing min-vh-100 d-flex align-items-center py-0" data-aos="fade-up">
  <div class="container">

    {# Logo #}
    <div class="container text-center my-4 pb-5">
      <a href="{% url 'core:home' %}">
        <img src="{% static 'images/logo/logo.png' %}" alt="Snobistic" style="height:56px;width:auto;">
      </a>
    </div>

    <div class="login-wrap">
      {# ==== Col stânga: Formular înregistrare ==== #}
      <div class="left">
        <div class="heading">
          <h4>Creează-ți cont pe Snobistic</h4>
          <p class="text-secondary small mt-1">
            Completează datele de mai jos pentru a-ți crea un cont de cumpărător sau vânzător.
            După înregistrare îți trimitem un email cu linkul de activare a contului.
          </p>
        </div>

        {# Mesaje Django #}
        {% if messages %}
          <div class="mt-3 mb-2">
            {% for m in messages %}
              <div class="alert alert-{{ m.tags|default:'info' }} mb-1">
                {{ m }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <form method="post" novalidate class="form-login" autocomplete="off" id="registerForm">
          {% csrf_token %}
          {% if request.GET.next %}
            <input type="hidden" name="next" value="{{ request.GET.next }}">
          {% endif %}

          {# Social sign-in – placeholder #}
          <div class="d-grid gap-2 mb-3">
            <div class="row">
              <div class="col-xl-6">
                <a class="tf-btn btn-fill d-flex align-items-center justify-content-center" href="#">
                  <img width="24" height="24"
                      src="https://img.icons8.com/fluency/48/google-logo.png"
                      alt="google-logo">
                  <span class="text text-button ms-2">Continuă cu Google</span>
                </a>
              </div>
              <div class="col-xl-6">
                <a class="tf-btn btn-fill d-flex align-items-center justify-content-center" href="#">
                  <img width="24" height="24"
                      src="https://img.icons8.com/fluency/48/facebook-new.png"
                      alt="facebook-logo">
                  <span class="text text-button ms-2">Continuă cu Facebook</span>
                </a>
              </div>
            </div>
          </div>

          <div class="text-center mb-3">
            <span class="text-secondary small">sau continuă cu email</span>
          </div>

          {% if form.non_field_errors %}
            <div class="alert alert-danger mb-3">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <div class="wrap">

            {# PAS 1 – rol + date de bază #}
            <div class="register-step" data-step="1">
              <div class="mb_20 text-center">
                <p class="text-secondary small mb-2">
                  Alege cum vrei să folosești Snobistic:
                </p>
                <div class="btn-group" role="group" aria-label="Rol">
                  {# Buyer #}
                  <input
                    type="radio"
                    class="btn-check"
                    name="{{ form.role.name }}"
                    id="role_buyer"
                    value="buyer"
                    {% if form.role.value == "buyer" or not form.role.value %}checked{% endif %}
                    autocomplete="off"
                  >
                  <label class="btn btn-outline-dark" for="role_buyer">
                    Vreau doar să cumpăr
                  </label>

                  {# Seller #}
                  <input
                    type="radio"
                    class="btn-check"
                    name="{{ form.role.name }}"
                    id="role_seller"
                    value="seller"
                    {% if form.role.value == "seller" %}checked{% endif %}
                    autocomplete="off"
                  >
                  <label class="btn btn-outline-dark" for="role_seller">
                    Vreau să vând și să cumpăr
                  </label>
                </div>
                {% if form.role.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.role.errors.as_text }}
                  </div>
                {% endif %}
              </div>

              <div class="row g-3 mb_12">
                <div class="col-md-6">
                  {{ form.first_name|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.last_name|as_crispy_field }}
                </div>
              </div>

              <div class="mb_12">
                {{ form.email|as_crispy_field }}
              </div>

              <div class="row g-3 mb_12">
                <div class="col-md-6">
                  {{ form.password1|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.password2|as_crispy_field }}
                </div>
              </div>
            </div>

            {# PAS 2 – telefon, data nașterii, cod recomandare #}
            <div class="register-step d-none" data-step="2">
              <div class="row g-3 mb_12">
                <div class="col-md-6">
                  {{ form.phone|as_crispy_field }}
                </div>
                <div class="col-md-6">
                  {{ form.date_of_birth|as_crispy_field }}
                </div>
              </div>

              <div class="mb_12">
                {{ form.referral_code|as_crispy_field }}
              </div>
            </div>

            {# PAS 3 – detalii firmă (opțional) + IBAN + termeni #}
            <div class="register-step d-none" data-step="3">
              {# Dacă CUI/TVA e gol, contul este considerat persoană fizică #}
              <div class="mb_12">
                {{ form.company_vat|as_crispy_field }}
              </div>

              <div id="iban-group" class="mb_12">
                {{ form.iban|as_crispy_field }}
              </div>

              <div class="form-check mb_12">
                {{ form.agree_terms }}
                <label class="form-check-label ms-1" for="{{ form.agree_terms.id_for_label }}">
                  Sunt de acord cu
                  <a href="{% url 'core:terms' %}" target="_blank">Termenii și Condițiile</a>,
                  precum și cu Politica de confidențialitate și Politica de cookies ale platformei Snobistic.
                </label>
                {% if form.agree_terms.errors %}
                  <div class="text-danger small mt-1">
                    {{ form.agree_terms.errors.as_text }}
                  </div>
                {% endif %}
              </div>

              <p class="text-secondary small mt-2">
                După trimiterea formularului îți vom trimite un email de activare. Verifică și folderul Spam/Promotions.
              </p>
            </div>

          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <button type="button"
                    class="tf-btn btn-line"
                    id="prevStepBtn">
              <span class="text text-button">Înapoi</span>
            </button>

            <button type="button"
                    class="tf-btn btn-fill"
                    id="nextStepBtn" style="margin-left:auto;">
              <span class="text text-button">Continuă</span>
            </button>

            <button type="submit"
                    class="tf-btn btn-fill d-none"
                    id="submitBtn">
              <span class="text text-button">Creează contul</span>
            </button>
          </div>

          <p class="text-secondary small text-center mt-3 mb-0">
            Nu împărtăși niciodată codurile de autentificare sau parola cu altcineva.
          </p>
        </form>
      </div>

      {# ==== Col dreapta: Ai deja cont? ==== #}
      <div class="right">
        <h4 class="mb_8">Ai deja cont?</h4>
        <p class="text-secondary">
          Dacă ai deja un cont Snobistic, autentifică-te pentru a-ți vedea comenzile,
          favoritele și licitațiile active.
        </p>
        <a href="{% url 'accounts:login' %}" class="tf-btn btn-fill mt-2 mb-4">
          <span class="text text-button">Autentifică-te</span>
        </a>
      </div>

    </div>
  </div>
</section>

<script>
  // IBAN doar pentru seller
  function toggleIban() {
    const sellerRadio = document.querySelector('input[name="role"][value="seller"]');
    const el = document.getElementById('iban-group');
    if (!el) return;
    el.style.display = (sellerRadio && sellerRadio.checked) ? 'block' : 'none';
  }

  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registerForm');
    const steps = Array.from(document.querySelectorAll('.register-step'));
    const prevBtn = document.getElementById('prevStepBtn');
    const nextBtn = document.getElementById('nextStepBtn');
    const submitBtn = document.getElementById('submitBtn');
    let currentStep = 1;
    const totalSteps = steps.length;

    function markInvalid(field, invalid) {
      if (!field) return;
      if (invalid) {
        field.classList.add('is-invalid');
      } else {
        field.classList.remove('is-invalid');
      }
    }

    function validateStep(step) {
      let valid = true;
      const stepEl = document.querySelector('.register-step[data-step="' + step + '"]');
      if (!stepEl) return true;

      // reset is-invalid în acest pas
      stepEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

      if (step === 1) {
        // role (radio)
        const roleInputs = Array.from(document.querySelectorAll('input[name="role"]'));
        const anyChecked = roleInputs.some(r => r.checked);
        if (!anyChecked) {
          valid = false;
          roleInputs.forEach(r => r.classList.add('is-invalid'));
        } else {
          roleInputs.forEach(r => r.classList.remove('is-invalid'));
        }

        const firstName = stepEl.querySelector('[name="first_name"]');
        markInvalid(firstName, !firstName || !firstName.value.trim());
        if (!firstName || !firstName.value.trim()) valid = false;

        const lastName = stepEl.querySelector('[name="last_name"]');
        markInvalid(lastName, !lastName || !lastName.value.trim());
        if (!lastName || !lastName.value.trim()) valid = false;

        const email = stepEl.querySelector('[name="email"]');
        markInvalid(email, !email || !email.value.trim());
        if (!email || !email.value.trim()) valid = false;

        const pw1 = stepEl.querySelector('[name="password1"]');
        markInvalid(pw1, !pw1 || !pw1.value.trim());
        if (!pw1 || !pw1.value.trim()) valid = false;

        const pw2 = stepEl.querySelector('[name="password2"]');
        markInvalid(pw2, !pw2 || !pw2.value.trim());
        if (!pw2 || !pw2.value.trim()) valid = false;
      }

      if (step === 2) {
        const phone = stepEl.querySelector('[name="phone"]');
        markInvalid(phone, !phone || !phone.value.trim());
        if (!phone || !phone.value.trim()) valid = false;

        const dob = stepEl.querySelector('[name="date_of_birth"]');
        markInvalid(dob, !dob || !dob.value.trim());
        if (!dob || !dob.value.trim()) valid = false;

        // referral_code este opțional
      }

      if (step === 3) {
        const agree = stepEl.querySelector('[name="agree_terms"]');
        const agreeInvalid = !agree || !agree.checked;
        markInvalid(agree, agreeInvalid);
        if (agreeInvalid) valid = false;

        const sellerRadio = document.querySelector('input[name="role"][value="seller"]');
        const isSeller = sellerRadio && sellerRadio.checked;
        if (isSeller) {
          const iban = stepEl.querySelector('[name="iban"]');
          const ibanInvalid = !iban || !iban.value.trim();
          markInvalid(iban, ibanInvalid);
          if (ibanInvalid) valid = false;
        }
      }

      return valid;
    }

    function updateStepUI() {
      steps.forEach(step => {
        const s = parseInt(step.getAttribute('data-step'), 10);
        step.classList.toggle('d-none', s !== currentStep);
      });

      // Înapoi – ascuns la primul pas
      if (currentStep === 1) {
        prevBtn.classList.add('d-none');
      } else {
        prevBtn.classList.remove('d-none');
      }

      // Next vs Submit
      if (currentStep === totalSteps) {
        nextBtn.classList.add('d-none');
        submitBtn.classList.remove('d-none');
      } else {
        nextBtn.classList.remove('d-none');
        submitBtn.classList.add('d-none');
      }

      toggleIban();
    }

    prevBtn.addEventListener('click', function() {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    });

    nextBtn.addEventListener('click', function() {
      if (!validateStep(currentStep)) {
        return;
      }
      if (currentStep < totalSteps) {
        currentStep++;
        updateStepUI();
      }
    });

    form.addEventListener('submit', function(e) {
      if (!validateStep(currentStep)) {
        e.preventDefault();
      }
    });

    document.querySelectorAll('input[name="role"]').forEach(r => {
      r.addEventListener('change', function() {
        toggleIban();
        if (currentStep === 3) {
          validateStep(3);
        }
      });
    });

    updateStepUI();
  });
</script>

{% endblock %}
