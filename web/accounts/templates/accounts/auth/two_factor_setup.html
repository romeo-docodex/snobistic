{% extends "base.html" %}
{% load static %}

{% block title %}Activează 2FA (TOTP) – Snobistic{% endblock %}

{% block content %}
<section class="tf-page-title">
  <div class="container">
    <div class="box-title text-center">
      <h4 class="title">Activează autentificarea în doi pași</h4>
      <div class="breadcrumb-list">
        <a class="breadcrumb-item" href="{% url 'core:home' %}">Acasă</a>
        <div class="breadcrumb-item dot"><span></span></div>
        <div class="breadcrumb-item current">2FA TOTP</div>
      </div>
    </div>
  </div>
</section>

<div class="flat-spacing-13">
  <div class="container-7">
    <div class="main-content-account">
      <div class="my-acount-content account-address">

        <!-- Intro + beneficii -->
        <div class="account-address-item">
          <p class="title text-md fw-medium mb-1">Protejează-ți contul cu 2FA</p>
          <div class="info-detail">
            <div class="box-infor">
              <p class="text-sm mb-2">
                Autentificarea în doi pași (2FA) adaugă un nivel suplimentar de securitate:
                pe lângă parolă, trebuie să introduci și un cod generat în aplicația ta de autentificare.
              </p>
              <ul class="text-sm mb-0">
                <li>Contul este mult mai greu de compromis chiar dacă cineva îți află parola.</li>
                <li>Codurile expiră rapid și sunt valabile doar câteva zeci de secunde.</li>
                <li>Funcționează cu aplicații standard: Google Authenticator, Microsoft Authenticator, Authy etc.</li>
              </ul>
              <p class="text-xxs text-grey mt-2 mb-0">
                2FA va fi activă doar după ce finalizezi pașii de mai jos și codul este verificat cu succes.
              </p>
            </div>
          </div>
        </div>

        <!-- Pasul 1 – QR -->
        <div class="account-address-item mt-3">
          <p class="title text-md fw-medium mb-1">Pasul 1 – Conectează aplicația de autentificare</p>
          <div class="info-detail">
            <div class="box-infor">
              <p class="text-sm mb-3">
                Deschide aplicația ta de autentificare și adaugă un cont nou, apoi:
              </p>
              <ol class="text-sm mb-3">
                <li>Alege opțiunea „Scanează cod QR”.</li>
                <li>Scanează codul de mai jos.</li>
              </ol>

              <div class="d-flex flex-column flex-md-row align-items-start gap-4">
                <div>
                  <div id="totp-qr"
                       class="mb-2"
                       aria-label="Cod QR pentru aplicația de autentificare">
                  </div>
                  <p class="text-xxs text-grey mb-0">
                    Dacă nu se încarcă QR-ul, poți folosi direct cheia de mai jos.
                  </p>
                </div>

                <div class="flex-grow-1">
                  <p class="text-sm text-muted mb-2">
                    Dacă nu poți scana codul, copiază manual cheia (URI otpauth):
                  </p>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="text"
                           id="otpauthUri"
                           class="form-control"
                           readonly
                           value="{{ otpauth_uri }}">
                    <button type="button"
                            class="tf-btn btn-out-line-dark"
                            id="copyUriBtn">
                      Copiază
                    </button>
                  </div>
                  <p class="text-xxs text-grey mt-2 mb-0">
                    În aplicație alege „Introdu manual cheia / Set up key” și lipește acest text.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pasul 2 – verificare cod -->
        <div class="account-address-item mt-3">
          <p class="title text-md fw-medium mb-1">Pasul 2 – Confirmă codul</p>
          <div class="info-detail">
            <div class="box-infor">
              <p class="text-sm mb-3">
                După ce ai adăugat contul în aplicația de autentificare, introdu mai jos codul de 6 cifre
                care se afișează în aplicație.
              </p>
              <form method="post"
                    action="{% url 'accounts:two_factor_setup_verify' %}"
                    class="form-default">
                {% csrf_token %}
                <div class="tf-field style-2 style-3">
                  <label for="code" class="mb-1">Cod TOTP (6 cifre)</label>
                  <input type="text"
                         name="code"
                         id="code"
                         inputmode="numeric"
                         pattern="[0-9]*"
                         maxlength="6"
                         class="form-control"
                         placeholder="Ex: 123456"
                         required>
                </div>

                <p class="text-xxs text-grey mt-2 mb-0">
                  Codul se schimbă la câteva secunde. Dacă expiră, introdu următorul cod afișat.
                </p>

                <div class="box-btn mt-3 d-flex flex-wrap gap-2">
                  <button class="tf-btn animate-btn" type="submit">
                    Verifică și activează 2FA
                  </button>
                  <a href="{% url 'accounts:profile_security' %}"
                     class="tf-btn btn-out-line-dark">
                    Renunță
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Sfaturi -->
        <div class="account-address-item mt-3">
          <p class="title text-md fw-medium mb-1">După activare</p>
          <div class="info-detail">
            <div class="box-infor">
              <ul class="text-sm mb-0">
                <li>Vei putea genera <strong>coduri de rezervă</strong> din secțiunea
                  <em>Securitate cont → Coduri de rezervă</em>.
                </li>
                <li>Nu partaja niciodată codurile 2FA sau cheia TOTP cu alte persoane.</li>
                <li>Dacă îți pierzi telefonul, vei avea nevoie de codurile de rezervă sau de ajutorul echipei de suport.</li>
              </ul>
            </div>
          </div>
        </div>

      </div> <!-- /.my-acount-content -->
    </div>
  </div>
</div>

<!-- QR generator (client-side) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
        integrity="sha512-MnYJ7r8o0g7sC+X4oE6yK2bP3mPq1m6T1oYFJ7gV7dHk5L1W0m8f8dV3h9Zx2m3fW3M9oV8o9gqk0L5lU4GQjw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
<script>
  (function () {
    var el = document.getElementById('totp-qr');
    if (window.QRCode && el) {
      try {
        new QRCode(el, {
          text: "{{ otpauth_uri|escapejs }}",
          width: 200,
          height: 200,
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {}
    }

    var btn = document.getElementById('copyUriBtn');
    var input = document.getElementById('otpauthUri');
    if (btn && input) {
      btn.addEventListener('click', function () {
        input.select();
        input.setSelectionRange(0, 99999);
        try {
          document.execCommand('copy');
          btn.textContent = 'Copiat!';
          setTimeout(function () {
            btn.textContent = 'Copiază';
          }, 1500);
        } catch (e) {}
      });
    }
  })();
</script>
{% endblock %}
