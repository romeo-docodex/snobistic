{# templates/accounts/auth/two_factor_setup.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Activează 2FA (TOTP) – Snobistic{% endblock %}

{# ✅ consistent cu auth pages: fără navbar/footer #}
{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<section class="flat-spacing min-vh-100 d-flex align-items-center py-0" data-aos="fade-up">
  <div class="container">

    {# Logo (consistent cu register/login/2fa) #}
    <div class="container text-center my-4 pb-5">
      <a href="{% url 'core:home' %}">
        <img src="{% static 'images/logo/logo.png' %}" alt="Snobistic" style="height:56px;width:auto;">
      </a>
    </div>

    <div class="login-wrap">
      {# ==== Col stânga: Setup + verify ==== #}
      <div class="left">
        <div class="heading">
          <h4>Activează autentificarea în doi pași</h4>
          <p class="text-secondary small mt-1 mb-0">
            Conectează o aplicație de autentificare (Google Authenticator, Microsoft Authenticator, Authy etc.).
            2FA devine activă doar după ce verifici codul.
          </p>
        </div>

        {# Mesaje Django #}
        {% if messages %}
          <div class="mt-3 mb-2" role="status" aria-live="polite">
            {% for m in messages %}
              <div class="alert alert-{{ m.tags|default:'info' }} mb-1">
                {{ m }}
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="wrap mt-3">

          {# Pas 1 #}
          <div class="mb-4">
            <h6 class="mb-2">Pasul 1 – Scanează codul QR</h6>
            <p class="text-secondary small mb-3">
              În aplicația ta, alege „Scan QR code” și scanează codul de mai jos.
            </p>

            <div class="d-flex flex-column flex-md-row align-items-start gap-4">
              <div>
                <div id="totp-qr"
                     class="mb-2"
                     aria-label="Cod QR pentru aplicația de autentificare">
                </div>
                <p class="text-secondary small mb-0">
                  Dacă nu se încarcă QR-ul, folosește metoda manuală din dreapta.
                </p>
              </div>

              <div class="flex-grow-1">
                <p class="text-secondary small mb-2">
                  Setup manual (URI otpauth):
                </p>
                <div class="d-flex gap-2 align-items-center">
                  <input type="text"
                         id="otpauthUri"
                         class="form-control"
                         readonly
                         value="{{ otpauth_uri }}"
                         aria-label="otpauth uri">
                  <button type="button"
                          class="tf-btn btn-out-line-dark"
                          id="copyUriBtn"
                          aria-label="Copiază URI">
                    Copiază
                  </button>
                </div>
                <p class="text-secondary small mt-2 mb-0">
                  În aplicație alege „Enter setup key / Introdu manual cheia” și lipește textul.
                </p>
              </div>
            </div>
          </div>

          <hr class="my-4">

          {# Pas 2 #}
          <div>
            <h6 class="mb-2">Pasul 2 – Confirmă codul</h6>
            <p class="text-secondary small mb-3">
              Introdu codul de <strong>6 cifre</strong> afișat în aplicația de autentificare.
            </p>

            <form method="post"
                  action="{% url 'accounts:two_factor_setup_verify' %}"
                  class="form-login"
                  autocomplete="off"
                  novalidate>
              {% csrf_token %}

              <fieldset class="mb_20">
                <label for="code" class="mb-1">Cod TOTP (6 cifre)</label>
                <input type="text"
                       name="code"
                       id="code"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       maxlength="6"
                       class="form-control"
                       placeholder="Ex: 123456"
                       required
                       autocomplete="one-time-code">
                <p class="text-secondary small mt-1 mb-0">
                  Codul se schimbă des. Dacă expiră, introdu următorul cod.
                </p>
              </fieldset>

              <div class="d-flex flex-wrap gap-2">
                <button class="tf-btn btn-fill" type="submit">
                  <span class="text text-button">Verifică și activează 2FA</span>
                </button>

                <a href="{% url 'accounts:profile_security' %}" class="tf-btn btn-out-line-dark">
                  Renunță
                </a>
              </div>
            </form>
          </div>

          <hr class="my-4">

          {# După activare #}
          <div>
            <h6 class="mb-2">După activare</h6>
            <ul class="text-secondary small ps-3 mb-0">
              <li>Vei primi/vedea <strong>coduri de rezervă</strong> (afișate o singură dată).</li>
              <li>Nu partaja niciodată codurile 2FA sau cheia TOTP.</li>
              <li>Dacă îți pierzi telefonul, vei avea nevoie de codurile de rezervă.</li>
            </ul>
          </div>

        </div>
      </div>

      {# ==== Col dreapta: beneficii & tips ==== #}
      <div class="right">
        <h4 class="mb_8">De ce merită 2FA?</h4>
        <p class="text-secondary">
          Chiar dacă cineva îți află parola, fără codul din aplicația ta nu se poate autentifica.
          E cel mai simplu upgrade de securitate pentru cont.
        </p>

        <p class="text-secondary mb-2">Sfaturi utile:</p>
        <ul class="text-secondary small ps-3 mb-2">
          <li>Ține telefonul cu ora setată automat (important pentru TOTP).</li>
          <li>Notează/Salvează codurile de rezervă într-un loc sigur.</li>
          <li>Dacă schimbi telefonul, reactivează 2FA pe noul dispozitiv.</li>
        </ul>

        <p class="text-secondary small mb-0">
          Dacă ai nevoie de ajutor, contactează suportul Snobistic.
        </p>
      </div>
    </div>
  </div>
</section>

{# QR generator (client-side) #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
        integrity="sha512-MnYJ7r8o0g7sC+X4oE6yK2bP3mPq1m6T1oYFJ7gV7dHk5L1W0m8f8dV3h9Zx2m3fW3M9oV8o9gqk0L5lU4GQjw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>

<script>
  (function () {
    var el = document.getElementById('totp-qr');
    if (window.QRCode && el) {
      try {
        new QRCode(el, {
          text: "{{ otpauth_uri|escapejs }}",
          width: 200,
          height: 200,
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {}
    }

    var btn = document.getElementById('copyUriBtn');
    var input = document.getElementById('otpauthUri');

    function copyTextFallback() {
      try {
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        return true;
      } catch (e) { return false; }
    }

    async function copyTextModern() {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(input.value);
          return true;
        }
      } catch (e) {}
      return copyTextFallback();
    }

    if (btn && input) {
      btn.addEventListener('click', async function () {
        var ok = await copyTextModern();
        if (ok) {
          var old = btn.textContent;
          btn.textContent = 'Copiat!';
          setTimeout(function () { btn.textContent = old; }, 1500);
        }
      });
    }
  })();
</script>
{% endblock %}
