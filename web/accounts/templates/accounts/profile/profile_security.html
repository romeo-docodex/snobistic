{% extends "base.html" %}
{% load static %}

{% block title %}Securitate cont – Snobistic{% endblock %}

{% block content %}
<!-- Title Page -->
<section class="tf-page-title">
  <div class="container">
    <div class="box-title text-center">
      <h4 class="title">Securitate cont</h4>
      <div class="breadcrumb-list">
        <a class="breadcrumb-item" href="{% url 'core:home' %}">Acasă</a>
        <div class="breadcrumb-item dot"><span></span></div>
        <div class="breadcrumb-item current">Cont</div>
      </div>
    </div>
  </div>
</section>

<!-- Main Content -->
<div class="flat-spacing-13">
  <div class="container-7">

    <!-- sidebar-account (mobil) -->
    <div class="btn-sidebar-mb d-lg-none">
      <button data-bs-toggle="offcanvas" data-bs-target="#mbAccount">
        <i class="icon icon-sidebar"></i>
      </button>
    </div>

    <!-- Account -->
    <div class="main-content-account">
      <!-- Sidebar desktop -->
      {% include "accounts/profile/_account_sidebar.html" with account_section="security" %}

      <!-- Content -->
      <div class="my-acount-content account-address">
        <h6 class="title-account mb-2">Setări de securitate</h6>

        <!-- Rezumat scurt status securitate -->
        <div class="mb-3">
          <span class="badge bg-light text-dark me-2 text-xs">
            Parolă: setată
          </span>

          {% if request.user.profile.two_factor_enabled %}
            <span class="badge bg-success text-xs">
              2FA activă ({{ request.user.profile.get_two_factor_method_display }})
            </span>
          {% else %}
            <span class="badge bg-warning text-dark text-xs">
              2FA dezactivată
            </span>
          {% endif %}

          {% if request.user.profile.last_2fa_at %}
            <span class="badge bg-light text-dark ms-2 text-xxs">
              Ultima verificare 2FA: {{ request.user.profile.last_2fa_at|date:"Y-m-d H:i" }}
            </span>
          {% endif %}
        </div>

        <div class="widget-inner-address">

          {# ============================ #}
          {# 1) PAROLĂ                    #}
          {# ============================ #}
          <div class="account-address-item mt-3">
            <p class="title text-md fw-medium">Parolă</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-md mb-1">
                  Schimbă parola folosită pentru autentificare pe Snobistic.
                </p>
                <p class="text-xxs text-grey mb-0">
                  Îți recomandăm o parolă unică, cu litere mari/mici, cifre și simboluri.
                  Evită parolele pe care le folosești și în alte conturi.
                </p>
              </div>
              <div class="box-btn d-flex flex-wrap gap-2 mt-2">
                <a href="{% url 'accounts:password_change' %}"
                   class="tf-btn btn-out-line-dark">
                  Schimbă parola
                </a>
                <a href="{% url 'accounts:password_reset' %}"
                   class="text-xs text-muted">
                  Ai uitat parola? Reseteaz-o prin email.
                </a>
              </div>
            </div>
          </div>

          {# ============================ #}
          {# 2) AUTENTIFICARE ÎN DOI PAȘI #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Autentificare în doi pași (2FA)</p>
            <div class="info-detail">
              <div class="box-infor">
                {% if request.user.profile.two_factor_enabled %}
                  <p class="text-md mb-1">
                    2FA este <strong>activată</strong> pentru contul tău.
                  </p>
                  <p class="text-sm mb-1">
                    Metodă curentă:
                    <strong>{{ request.user.profile.get_two_factor_method_display }}</strong>.
                  </p>
                  <p class="text-xxs text-grey mb-0">
                    La fiecare autentificare ți se va cere un cod suplimentar (din aplicație / email / SMS),
                    în funcție de metoda activă.
                  </p>
                {% else %}
                  <p class="text-md mb-1">
                    2FA este <strong>dezactivată</strong>.
                  </p>
                  <p class="text-sm mb-0">
                    Îți recomandăm să activezi 2FA pentru a-ți proteja contul împotriva accesului neautorizat.
                  </p>
                {% endif %}
              </div>

              <div class="box-btn d-flex flex-wrap gap-2 mt-3">

                {# Dezactivare 2FA (dacă este activă) #}
                {% if request.user.profile.two_factor_enabled %}
                  <form method="post" action="{% url 'accounts:disable_2fa' %}">
                    {% csrf_token %}
                    <button class="tf-btn btn-out-line-dark" type="submit">
                      Dezactivează 2FA
                    </button>
                  </form>
                {% endif %}

                {# Activează / configurează TOTP #}
                <form method="post" action="{% url 'accounts:enable_2fa' %}">
                  {% csrf_token %}
                  <button class="tf-btn btn-out-line-dark" type="submit">
                    Activează 2FA în aplicație (TOTP)
                  </button>
                </form>

                {# Activează 2FA prin email #}
                <form method="post" action="{% url 'accounts:enable_2fa_email' %}">
                  {% csrf_token %}
                  <button class="tf-btn btn-out-line-dark" type="submit">
                    Activează 2FA prin Email
                  </button>
                </form>

                {# Activează 2FA prin SMS #}
                <form method="post" action="{% url 'accounts:enable_2fa_sms' %}">
                  {% csrf_token %}
                  <button class="tf-btn btn-out-line-dark" type="submit">
                    Activează 2FA prin SMS
                  </button>
                </form>
              </div>

              <p class="text-xxs text-grey mt-2 mb-0">
                Nu partaja codurile de autentificare cu nimeni. Echipa Snobistic nu îți va cere niciodată codurile 2FA.
              </p>
            </div>
          </div>

          {# ============================ #}
          {# 2b) CODURI DE REZERVĂ        #}
          {# ============================ #}
          <div class="account-address-item mt-3">
            <p class="title text-md fw-medium">Coduri de rezervă 2FA</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-2">
                  Codurile de rezervă îți permit să intri în cont dacă îți pierzi telefonul sau
                  nu mai ai acces la aplicația de autentificare.
                </p>

                {% if request.user.profile.backup_codes %}
                  <details>
                    <summary class="text-sm">Arată codurile (nu le partaja cu nimeni)</summary>
                    <ul class="mt-2">
                      {% for c in request.user.profile.backup_codes %}
                        <li><code>{{ c }}</code></li>
                      {% endfor %}
                    </ul>
                  </details>
                {% else %}
                  <p class="text-md mb-0">
                    Nu există coduri de rezervă generate. Acestea se vor genera automat
                    când activezi 2FA TOTP sau le poți regenera mai jos.
                  </p>
                {% endif %}
              </div>
              <div class="box-btn mt-2">
                <form method="post" action="{% url 'accounts:regenerate_backup_codes' %}">
                  {% csrf_token %}
                  <button class="tf-btn btn-out-line-dark" type="submit">
                    Generează coduri backup din nou
                  </button>
                </form>
              </div>
              <p class="text-xxs text-grey mt-2 mb-0">
                După regenerare, <strong>codurile vechi nu vor mai funcționa</strong>. Salvează noile coduri într-un loc sigur.
              </p>
            </div>
          </div>

          {# ============================ #}
          {# 3) DISPOZITIVE DE ÎNCREDERE  #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Dispozitive de încredere</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-2">
                  Pe dispozitivele de încredere, îți vom cere mai rar codul 2FA.
                  Poți revoca oricând un dispozitiv dacă nu îl mai folosești sau nu îl recunoști.
                </p>

                {% if devices %}
                  <ul class="list-unstyled mb-0">
                    {% for d in devices %}
                      <li class="mb-3">
                        <div class="text-sm">
                          <strong>{{ d.label|default:"Dispozitiv" }}</strong><br>
                          Browser / Client: {{ d.user_agent|truncatechars:80 }}<br>
                          IP: {{ d.ip|default:"-" }} ·
                          Adăugat: {{ d.created_at|date:"Y-m-d H:i" }} ·
                          Ultima utilizare: {{ d.last_used_at|date:"Y-m-d H:i" }} ·
                          Expiră la: {{ d.expires_at|date:"Y-m-d" }}
                        </div>
                        <form method="post"
                              action="{% url 'accounts:revoke_trusted_device' pk=d.pk %}"
                              class="mt-1">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger" type="submit">
                            Revocă dispozitivul
                          </button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-md mb-0">Nu există dispozitive de încredere memorate.</p>
                {% endif %}
              </div>
            </div>
          </div>

          {# ============================ #}
          {# 4) ACTIVITATE RECENTĂ        #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Activitate recentă</p>
            <div class="info-detail">
              <div class="box-infor">
                {% if events %}
                  <p class="text-sm mb-2">
                    Ultimele acțiuni de securitate în contul tău (logări, 2FA, schimbări de parolă).
                  </p>
                  <ul class="list-unstyled mb-0">
                    {% for e in events|slice:":10" %}
                      <li class="text-sm mb-1">
                        <strong>{{ e.get_event_display }}</strong>
                        — {{ e.created_at|date:"Y-m-d H:i" }}
                        (IP: {{ e.ip|default:"-" }})
                      </li>
                    {% endfor %}
                  </ul>
                  <p class="text-xxs text-grey mt-2 mb-0">
                    Dacă observi o activitate pe care nu o recunoști, schimbă imediat parola
                    și deconectează-te de pe dispozitivele suspecte.
                  </p>
                {% else %}
                  <p class="text-md mb-0">Nu există evenimente de securitate înregistrate încă.</p>
                {% endif %}
              </div>
            </div>
          </div>

          {# ============================ #}
          {# 5) ȘTERGERE CONT             #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium text-danger">Ștergere cont</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-md mb-1">
                  Ștergerea contului este <strong>ireversibilă</strong>.
                </p>
                <p class="text-sm mb-0">
                  Vom trimite un cod de confirmare pe emailul tău
                  (<strong>{{ request.user.email }}</strong>). După confirmare, contul va fi șters
                  conform politicii Snobistic.
                </p>
              </div>
              <div class="box-btn d-flex flex-wrap gap-2 mt-2">
                <form method="post" action="{% url 'accounts:delete_account_request' %}">
                  {% csrf_token %}
                  <button type="submit" class="tf-btn btn-out-line-dark">
                    Trimite codul și continuă
                  </button>
                </form>
                <a href="{% url 'accounts:delete_account_confirm' %}"
                   class="tf-btn btn-out-line-dark">
                  Am deja codul
                </a>
              </div>
              <p class="text-xxs text-grey mt-2 mb-0">
                Dacă nu ai inițiat tu această acțiune, ignoră orice email primit.
              </p>
            </div>
          </div>

        </div> <!-- /widget-inner-address -->
      </div> <!-- /my-acount-content -->
    </div> <!-- /main-content-account -->

  </div>
</div>
{% endblock %}
