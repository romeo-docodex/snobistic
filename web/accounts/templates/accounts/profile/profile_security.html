{% extends "base.html" %}
{% load static %}

{% block title %}Securitate cont – Snobistic{% endblock %}

{% block content %}
<section class="tf-page-title">
  <div class="container">
    <div class="box-title text-center">
      <h4 class="title">Securitate cont</h4>
      <div class="breadcrumb-list">
        <a class="breadcrumb-item" href="{% url 'core:home' %}">Acasă</a>
        <div class="breadcrumb-item dot"><span></span></div>
        <div class="breadcrumb-item current">Securitate</div>
      </div>
    </div>
  </div>
</section>

<div class="flat-spacing-13">
  <div class="container-7">

    <div class="btn-sidebar-mb d-lg-none">
      <button data-bs-toggle="offcanvas" data-bs-target="#mbAccount">
        <i class="icon icon-sidebar"></i>
      </button>
    </div>

    <div class="main-content-account">
      {% include "accounts/profile/_account_sidebar.html" with account_section="security" %}

      <div class="my-acount-content account-address">
        <h6 class="title-account mb-2">Setări de securitate</h6>

        {# Mesaje Django (dacă base nu le afișează) #}
        {% if messages %}
          <div class="mt-2 mb-3">
            {% for m in messages %}
              <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}

        {# Rezumat scurt #}
        <div class="mb-3">
          <span class="badge bg-light text-dark me-2 text-xs">Parolă: setată</span>

          {% if request.user.profile.two_factor_enabled %}
            <span class="badge bg-success text-xs">
              2FA activă ({{ request.user.profile.get_two_factor_method_display }})
            </span>
          {% else %}
            <span class="badge bg-warning text-dark text-xs">2FA dezactivată</span>
          {% endif %}

          {% if request.user.profile.last_2fa_at %}
            <span class="badge bg-light text-dark ms-2 text-xxs">
              Ultima verificare 2FA: {{ request.user.profile.last_2fa_at|date:"Y-m-d H:i" }}
            </span>
          {% endif %}
        </div>

        <div class="widget-inner-address">

          {# ============================ #}
          {# A) CHANGE PASSWORD           #}
          {# ============================ #}
          <div class="account-address-item mt-3">
            <p class="title text-md fw-medium">Parolă</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-md mb-1">Schimbă parola contului.</p>
                <p class="text-xxs text-grey mb-0">
                  Recomandat: parolă unică + combinație de litere, cifre, simboluri.
                </p>
              </div>
              <div class="box-btn d-flex flex-wrap gap-2 mt-2">
                <a href="{% url 'accounts:password_change' %}" class="tf-btn btn-out-line-dark">
                  Schimbă parola
                </a>
                <a href="{% url 'accounts:password_reset' %}" class="text-xs text-muted">
                  Ai uitat parola? Reseteaz-o prin email.
                </a>
              </div>
            </div>
          </div>

          {# ============================ #}
          {# B) EMAIL CHANGE (POST-only)  #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Schimbare email</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-2">
                  Email curent: <strong>{{ request.user.email }}</strong>
                </p>
                <p class="text-xxs text-grey mb-0">
                  Vei primi un link de confirmare pe noua adresă de email.
                </p>
              </div>

              <div class="box-btn mt-2">
                <form method="post" action="{% url 'accounts:email_change_request' %}" class="row g-2 align-items-center">
                  {% csrf_token %}
                  <div class="col-12 col-md-8">
                    <input type="email"
                           name="new_email"
                           class="form-control"
                           placeholder="nou@email.com"
                           required>
                  </div>
                  <div class="col-12 col-md-4">
                    <button type="submit" class="tf-btn btn-out-line-dark w-100">
                      Trimite confirmarea
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          {# ============================ #}
          {# C) 2FA MANAGEMENT            #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Autentificare în doi pași (2FA)</p>
            <div class="info-detail">
              <div class="box-infor">
                {% if request.user.profile.two_factor_enabled %}
                  <p class="text-md mb-1">
                    2FA este <strong>activată</strong>.
                  </p>
                  <p class="text-sm mb-1">
                    Metodă curentă: <strong>{{ request.user.profile.get_two_factor_method_display }}</strong>
                  </p>
                {% else %}
                  <p class="text-md mb-1">
                    2FA este <strong>dezactivată</strong>.
                  </p>
                  <p class="text-sm mb-0">
                    Activează 2FA pentru un strat suplimentar de securitate.
                  </p>
                {% endif %}
              </div>

              <div class="box-btn d-flex flex-wrap gap-2 mt-3">

                {# Enable (plan: links) #}
                <a href="{% url 'accounts:enable_2fa' %}" class="tf-btn btn-out-line-dark">
                  Activează TOTP (aplicație)
                </a>
                <a href="{% url 'accounts:enable_2fa_email' %}" class="tf-btn btn-out-line-dark">
                  Activează 2FA prin Email
                </a>
                <a href="{% url 'accounts:enable_2fa_sms' %}" class="tf-btn btn-out-line-dark">
                  Activează 2FA prin SMS
                </a>

                {# Disable (POST-only) #}
                {% if request.user.profile.two_factor_enabled %}
                  <form method="post" action="{% url 'accounts:disable_2fa' %}">
                    {% csrf_token %}
                    <button class="tf-btn btn-out-line-dark" type="submit">
                      Dezactivează 2FA
                    </button>
                  </form>
                {% endif %}
              </div>

              <p class="text-xxs text-grey mt-2 mb-0">
                Nu partaja codurile 2FA. Echipa Snobistic nu îți va cere niciodată codurile.
              </p>
            </div>
          </div>

          {# Backup codes: afișezi DOAR backup_codes_once (o singură dată) #}
          <div class="account-address-item mt-3">
            <p class="title text-md fw-medium">Coduri de rezervă 2FA</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-2">
                  Folosește un cod de rezervă dacă nu mai ai acces la metoda 2FA (telefon/aplicație).
                </p>

                {% if backup_codes_once %}
                  <div class="alert alert-warning mb-2">
                    <strong>Afișate o singură dată.</strong> Copiază-le acum și salvează-le într-un loc sigur.
                  </div>
                  <ul class="mb-0">
                    {% for c in backup_codes_once %}
                      <li><code>{{ c }}</code></li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-xxs text-grey mb-0">
                    Dacă tocmai ai activat 2FA sau ai regenerat codurile, ele apar aici o singură dată.
                  </p>
                {% endif %}
              </div>

              <div class="box-btn mt-2">
                <form method="post" action="{% url 'accounts:regenerate_backup_codes' %}">
                  {% csrf_token %}
                  <button class="tf-btn btn-out-line-dark" type="submit">
                    Regenerare coduri de rezervă
                  </button>
                </form>
              </div>

              <p class="text-xxs text-grey mt-2 mb-0">
                După regenerare, codurile vechi nu vor mai funcționa.
              </p>
            </div>
          </div>

          {# ============================ #}
          {# D) TRUSTED DEVICES           #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Dispozitive de încredere</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-2">
                  Poți revoca un dispozitiv dacă nu îl recunoști sau nu îl mai folosești.
                </p>

                {% if devices %}
                  <ul class="list-unstyled mb-0">
                    {% for d in devices %}
                      <li class="mb-3">
                        <div class="text-sm">
                          <strong>{{ d.label|default:"Dispozitiv" }}</strong><br>
                          Browser/Client: {{ d.user_agent|truncatechars:80 }}<br>
                          IP: {{ d.ip|default:"-" }} ·
                          Adăugat: {{ d.created_at|date:"Y-m-d H:i" }} ·
                          Ultima utilizare: {{ d.last_used_at|date:"Y-m-d H:i" }} ·
                          Expiră: {{ d.expires_at|date:"Y-m-d" }}
                        </div>

                        <form method="post"
                              action="{% url 'accounts:revoke_trusted_device' pk=d.pk %}"
                              class="mt-1">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-danger" type="submit">
                            Revocă dispozitivul
                          </button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-md mb-0">Nu există dispozitive de încredere memorate.</p>
                {% endif %}
              </div>
            </div>
          </div>

          {# ============================ #}
          {# E) EVENTS (ultimele 20)      #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Activitate recentă</p>
            <div class="info-detail">
              <div class="box-infor">
                {% if events %}
                  <p class="text-sm mb-2">
                    Ultimele acțiuni de securitate (max 20).
                  </p>
                  <ul class="list-unstyled mb-0">
                    {% for e in events %}
                      <li class="text-sm mb-1">
                        <strong>{{ e.get_event_display }}</strong>
                        — {{ e.created_at|date:"Y-m-d H:i" }}
                        (IP: {{ e.ip|default:"-" }})
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p class="text-md mb-0">Nu există evenimente de securitate înregistrate încă.</p>
                {% endif %}
              </div>
            </div>
          </div>

          {# ============================ #}
          {# G) LOGOUT ALL SESSIONS       #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">Sesiuni</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-0">
                  Te deconectează de pe toate dispozitivele și revocă dispozitivele de încredere.
                </p>
              </div>
              <div class="box-btn mt-2">
                <form method="post" action="{% url 'accounts:logout_all_sessions' %}">
                  {% csrf_token %}
                  <button type="submit" class="tf-btn btn-out-line-dark">
                    Logout din toate sesiunile
                  </button>
                </form>
              </div>
            </div>
          </div>

          {# ============================ #}
          {# H) GDPR EXPORT (GET)         #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium">GDPR</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-sm mb-0">
                  Descarcă un export al datelor tale (în iterația curentă este placeholder).
                </p>
              </div>
              <div class="box-btn mt-2">
                <a href="{% url 'accounts:gdpr_export' %}" class="tf-btn btn-out-line-dark">
                  Export GDPR
                </a>
              </div>
            </div>
          </div>

          {# ============================ #}
          {# F) DELETE ACCOUNT            #}
          {# ============================ #}
          <div class="account-address-item mt-4">
            <p class="title text-md fw-medium text-danger">Ștergere cont</p>
            <div class="info-detail">
              <div class="box-infor">
                <p class="text-md mb-1">
                  Ștergerea contului este <strong>ireversibilă</strong>.
                </p>
                <p class="text-sm mb-0">
                  Vom trimite un cod pe emailul tău (<strong>{{ request.user.email }}</strong>).
                </p>
              </div>
              <div class="box-btn d-flex flex-wrap gap-2 mt-2">
                <form method="post" action="{% url 'accounts:delete_account_request' %}">
                  {% csrf_token %}
                  <button type="submit" class="tf-btn btn-out-line-dark">
                    Trimite codul și continuă
                  </button>
                </form>
                <a href="{% url 'accounts:delete_account_confirm' %}" class="tf-btn btn-out-line-dark">
                  Am deja codul
                </a>
              </div>
              <p class="text-xxs text-grey mt-2 mb-0">
                Dacă nu ai inițiat tu acțiunea, ignoră orice email primit.
              </p>
            </div>
          </div>

        </div> <!-- /widget-inner-address -->
      </div> <!-- /my-acount-content -->
    </div> <!-- /main-content-account -->

  </div>
</div>
{% endblock %}
