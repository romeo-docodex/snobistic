{% extends "base.html" %}
{% load static %}
{% block title %}Adaugă produs — Mărime & detalii{% endblock %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}

<style>
  input.form-control[type="number"]::-webkit-outer-spin-button,
  input.form-control[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input.form-control[type="number"] {
    -moz-appearance: textfield;
  }
  .input-group-text {
    background: transparent;
    font-size: 12px;
  }
</style>

<section class="flat-spacing min-vh-100 d-flex align-items-center py-0" data-aos="fade-up">
  <div class="container">
    <div class="login-wrap">

      <div class="left">
        <div class="heading">
          <div class="small text-secondary mb-1">
            Pasul {{ wizard.steps.step1 }} din {{ wizard.steps.count }}
          </div>
          <h4>Mărime, stare & detalii</h4>
          <p class="small text-secondary mb-0">
            Completează mărimea, starea produsului, materialul și culoarea de bază.
            Măsurătorile se completează în pasul următor.
          </p>
        </div>

        <div class="wrap">
          {% if form.non_field_errors %}
            <div class="alert alert-danger mb-3">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <form id="wizardForm"
                method="post"
                enctype="multipart/form-data"
                class="form-login"
                novalidate>
            {% csrf_token %}
            {{ wizard.management_form }}

            <!-- Mărime & stare -->
            <div class="mb-4">
              <h6 class="mb-2">Mărime & stare</h6>

              <div class="row g-3">
                <div class="col-md-6">

                  {% if form.size.is_hidden %}
                    {{ form.size }}
                    <label class="body-text-1 mb-1 d-block">Mărime</label>
                    <div class="alert alert-info py-2 mb-0 small">
                      Tip mărime: <strong>{{ form.size_mode_label }}</strong>
                    </div>
                  {% else %}
                    <label class="body-text-1 mb-1 d-block">
                      {{ form.size.label }} <span class="text-danger">*</span>
                    </label>
                    {{ form.size }}
                    {% for error in form.size.errors %}
                      <div class="text-danger small mt-1">{{ error }}</div>
                    {% endfor %}
                    {% if form.size_mode_label %}
                      <div class="form-text small text-muted mt-1">
                        Selectat automat: <strong>{{ form.size_mode_label }}</strong>
                      </div>
                    {% endif %}
                  {% endif %}

                </div>

                <div class="col-md-6">
                  <label class="body-text-1 mb-1 d-block">
                    {{ form.condition.label }} <span class="text-danger">*</span>
                  </label>
                  {{ form.condition }}
                  {% for error in form.condition.errors %}
                    <div class="text-danger small mt-1">{{ error }}</div>
                  {% endfor %}
                </div>
              </div>

              {% if form.size_alpha %}
                {% if form.size_alpha.is_hidden %}
                  {{ form.size_alpha }}
                {% endif %}
              {% endif %}

              <div class="mt-3">
                <label class="body-text-1 mb-1 d-block">
                  {{ form.condition_notes.label }}
                </label>
                {{ form.condition_notes }}
                {% for error in form.condition_notes.errors %}
                  <div class="text-danger small mt-1">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <!-- Mărimi numerice / pantofi -->
            {% if form.show_numeric_block %}
              <div class="mb-4">
                <h6 class="mb-2">Mărimi numerice</h6>
                <div class="row g-3">

                  {% if form.shoe_size_eu %}
                    <div class="col-md-6" id="wrap-shoe-eu">
                      {% if form.shoe_size_eu.is_hidden %}
                        {{ form.shoe_size_eu }}
                      {% else %}
                        <label class="body-text-1 mb-1 d-block">
                          {{ form.shoe_size_eu.label }}
                        </label>
                        {{ form.shoe_size_eu }}
                        {% for error in form.shoe_size_eu.errors %}
                          <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if form.size_fr %}
                    <div class="col-md-4" id="wrap-size-fr">
                      {% if form.size_fr.is_hidden %}
                        {{ form.size_fr }}
                      {% else %}
                        <label class="body-text-1 mb-1 d-block">{{ form.size_fr.label }}</label>
                        {{ form.size_fr }}
                        {% for error in form.size_fr.errors %}
                          <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if form.size_it %}
                    <div class="col-md-4" id="wrap-size-it">
                      {% if form.size_it.is_hidden %}
                        {{ form.size_it }}
                      {% else %}
                        <label class="body-text-1 mb-1 d-block">{{ form.size_it.label }}</label>
                        {{ form.size_it }}
                        {% for error in form.size_it.errors %}
                          <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if form.size_gb %}
                    <div class="col-md-4" id="wrap-size-gb">
                      {% if form.size_gb.is_hidden %}
                        {{ form.size_gb }}
                      {% else %}
                        <label class="body-text-1 mb-1 d-block">{{ form.size_gb.label }}</label>
                        {{ form.size_gb }}
                        {% for error in form.size_gb.errors %}
                          <div class="text-danger small mt-1">{{ error }}</div>
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% endif %}

                </div>

                {% if not form.size.is_hidden %}
                  <div class="form-text small text-muted mt-2">
                    Dacă produsul este numeric, alege sistemul (FR/GB/IT) din selectorul de mărime.
                  </div>
                {% endif %}
              </div>
            {% endif %}

            <!-- Material & culoare -->
            <div class="mb-4">
              <h6 class="mb-2">Material & culoare</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="body-text-1 mb-1 d-block">
                    {{ form.material.label }}
                  </label>
                  {{ form.material }}
                  {% for error in form.material.errors %}
                    <div class="text-danger small mt-1">{{ error }}</div>
                  {% endfor %}
                  <div class="form-text small text-muted mt-1">
                    Alege <strong>un singur material</strong>.
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="body-text-1 mb-1 d-block">
                    {{ form.base_color.label }}
                  </label>

                  <select
                      name="{{ form.base_color.html_name }}"
                      id="{{ form.base_color.id_for_label }}"
                      class="form-select js-color-select">
                    <option value="">---------</option>

                    {% with current_value=form.base_color.value|stringformat:"s" %}
                      {% for color in form.fields.base_color.queryset %}
                        <option
                          value="{{ color.pk }}"
                          data-hex="{{ color.hex_code }}"
                          {% if current_value == color.pk|stringformat:"s" %}selected{% endif %}
                        >
                          {{ color.name }}
                        </option>
                      {% endfor %}
                    {% endwith %}
                  </select>

                  {% for error in form.base_color.errors %}
                    <div class="text-danger small mt-1">{{ error }}</div>
                  {% endfor %}
                  <div class="form-text small text-muted mt-1">
                    Alege <strong>culoarea de bază</strong> (folosită în filtre).
                  </div>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>

      <div class="right">
        <h4 class="mb_8">De ce contează detaliile?</h4>
        <p class="small text-secondary mb-3">
          Mărimea corectă + materialul și o culoare de bază cresc conversia și reduc retururile.
        </p>
        <div class="button-submit d-flex gap-2">
          <a href="{{ cancel_url }}" class="tf-btn btn-outline text-transform-none">
            <span class="text">Renunță</span>
          </a>
          <button class="tf-btn btn-outline"
                  name="wizard_goto_step"
                  value="{{ wizard.steps.prev }}"
                  type="submit"
                  form="wizardForm">
            <span class="text">Înapoi</span>
          </button>
          <button class="tf-btn btn-fill" type="submit" form="wizardForm">
            <span class="text text-button">Continuă</span>
          </button>
        </div>
      </div>

    </div><!-- /.login-wrap -->
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.jQuery || !jQuery.fn.select2) {
      console.warn('Select2 nu este încărcat.');
    } else {
      function formatColorOption (state) {
        if (!state.id) return state.text;

        var hex = $(state.element).data('hex');
        var text = state.text || '';

        if (!hex) return text;

        var $container = $(
          '<span class="snobistic-color-option">' +
            '<span class="snobistic-color-swatch"></span>' +
            '<span class="snobistic-color-label"></span>' +
          '</span>'
        );
        $container.find('.snobistic-color-swatch').css({
          display: 'inline-block',
          width: '14px',
          height: '14px',
          'border-radius': '4px',
          'margin-right': '8px',
          'vertical-align': 'middle',
          'background-color': hex,
          'border': '1px solid rgba(0,0,0,0.1)'
        });
        $container.find('.snobistic-color-label').text(text);

        return $container;
      }

      $('.js-color-select').select2({
        width: '100%',
        templateResult: formatColorOption,
        templateSelection: formatColorOption,
        minimumResultsForSearch: -1
      });
    }

    var sizeEl = document.getElementById('{{ form.size.id_for_label }}');
    var wrapFR = document.getElementById('wrap-size-fr');
    var wrapIT = document.getElementById('wrap-size-it');
    var wrapGB = document.getElementById('wrap-size-gb');

    function toggleNumericBySize() {
      if (!sizeEl) return;
      var v = sizeEl.value;
      if (wrapFR) wrapFR.style.display = (v === 'FR 28–58') ? '' : 'none';
      if (wrapIT) wrapIT.style.display = (v === 'IT 32–66') ? '' : 'none';
      if (wrapGB) wrapGB.style.display = (v === 'GB 2–30') ? '' : 'none';
    }

    if (sizeEl) {
      sizeEl.addEventListener('change', toggleNumericBySize);
      toggleNumericBySize();
    }
  });
</script>

{% endblock %}
