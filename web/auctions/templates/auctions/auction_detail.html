{# templates/auctions/auction_detail.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}{{ auction.product.title }} – Licitație{% endblock %}

{% block content %}

{% with p=auction.product %}
{% with first_extra=p.images.first %}

<!-- Breadcrumb -->
<div class="breadcrumb-sec">
  <div class="container">
    <div class="breadcrumb-wrap">
      <div class="breadcrumb-list">
        <a class="breadcrumb-item" href="{% url 'auctions:auction_list' %}">Licitații</a>
        <div class="breadcrumb-item dot"><span></span></div>

        <a class="breadcrumb-item" href="{{ p.category.get_absolute_url }}">{{ p.category.name }}</a>

        {% if p.subcategory %}
          <div class="breadcrumb-item dot"><span></span></div>
          <span class="breadcrumb-item">{{ p.subcategory.get_breadcrumb }}</span>
        {% endif %}

        <div class="breadcrumb-item dot"><span></span></div>
        <div class="breadcrumb-item current">{{ p.title }}</div>
      </div>
    </div>
  </div>
</div>
<!-- /Breadcrumb -->

<!-- Main -->
<section class="flat-single-product">
  <div class="tf-main-product section-image-zoom">
    <div class="container">
      <div class="row">

        <!-- Images (identic product_detail.html, cu fallback) -->
        <div class="col-md-6">
          <div class="tf-product-media-wrap sticky-top">
            <div class="product-thumbs-slider">
              <div class="flat-wrap-media-product">
                <div dir="ltr" class="swiper tf-product-media-main" id="gallery-swiper-started">
                  <div class="swiper-wrapper">

                    {% if p.main_image %}
                      <!-- main image -->
                      <div class="swiper-slide">
                        <a href="{{ p.main_image.url }}" target="_blank" class="item" data-pswp-width="1200" data-pswp-height="1200">
                          <img class="tf-image-zoom lazyload"
                               data-zoom="{{ p.main_image.url }}"
                               data-src="{{ p.main_image.url }}"
                               src="{{ p.main_image.url }}"
                               alt="{{ p.title }}">
                        </a>
                      </div>

                      <!-- extra images -->
                      {% for img in p.images.all %}
                        {% if img.image %}
                        <div class="swiper-slide">
                          <a href="{{ img.image.url }}" target="_blank" class="item" data-pswp-width="1200" data-pswp-height="1200">
                            <img class="tf-image-zoom lazyload"
                                 data-zoom="{{ img.image.url }}"
                                 data-src="{{ img.image.url }}"
                                 src="{{ img.image.url }}"
                                 alt="{{ img.alt_text|default:p.title }}">
                          </a>
                        </div>
                        {% endif %}
                      {% endfor %}

                    {% elif first_extra and first_extra.image %}
                      <!-- main fallback -->
                      <div class="swiper-slide">
                        <a href="{{ first_extra.image.url }}" target="_blank" class="item" data-pswp-width="1200" data-pswp-height="1200">
                          <img class="tf-image-zoom lazyload"
                               data-zoom="{{ first_extra.image.url }}"
                               data-src="{{ first_extra.image.url }}"
                               src="{{ first_extra.image.url }}"
                               alt="{{ p.title }}">
                        </a>
                      </div>

                      {% for img in p.images.all|slice:"1:" %}
                        {% if img.image %}
                        <div class="swiper-slide">
                          <a href="{{ img.image.url }}" target="_blank" class="item" data-pswp-width="1200" data-pswp-height="1200">
                            <img class="tf-image-zoom lazyload"
                                 data-zoom="{{ img.image.url }}"
                                 data-src="{{ img.image.url }}"
                                 src="{{ img.image.url }}"
                                 alt="{{ img.alt_text|default:p.title }}">
                          </a>
                        </div>
                        {% endif %}
                      {% endfor %}
                    {% endif %}

                  </div>
                </div>
                <div class="swiper-button-next nav-swiper thumbs-next"></div>
                <div class="swiper-button-prev nav-swiper thumbs-prev"></div>
              </div>

              <div dir="ltr" class="swiper tf-product-media-thumbs other-image-zoom" data-preview="4" data-direction="vertical">
                <div class="swiper-wrapper stagger-wrap">

                  {% if p.main_image %}
                    <!-- thumbs main -->
                    <div class="swiper-slide stagger-item">
                      <div class="item">
                        <img class="lazyload" data-src="{{ p.main_image.url }}" src="{{ p.main_image.url }}" alt="{{ p.title }}">
                      </div>
                    </div>
                    <!-- thumbs extras -->
                    {% for img in p.images.all %}
                      {% if img.image %}
                      <div class="swiper-slide stagger-item">
                        <div class="item">
                          <img class="lazyload" data-src="{{ img.image.url }}" src="{{ img.image.url }}" alt="{{ img.alt_text|default:p.title }}">
                        </div>
                      </div>
                      {% endif %}
                    {% endfor %}

                  {% elif first_extra and first_extra.image %}
                    <div class="swiper-slide stagger-item">
                      <div class="item">
                        <img class="lazyload" data-src="{{ first_extra.image.url }}" src="{{ first_extra.image.url }}" alt="{{ p.title }}">
                      </div>
                    </div>
                    {% for img in p.images.all|slice:"1:" %}
                      {% if img.image %}
                      <div class="swiper-slide stagger-item">
                        <div class="item">
                          <img class="lazyload" data-src="{{ img.image.url }}" src="{{ img.image.url }}" alt="{{ img.alt_text|default:p.title }}">
                        </div>
                      </div>
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                </div>
              </div>

            </div>
          </div>
        </div>
        <!-- /Images -->

        <!-- Info (dreapta) — copiat ca structură din product_detail.html + bid form -->
        <div class="col-md-6">
          <div class="tf-zoom-main"></div>
          <div class="tf-product-info-wrap other-image-zoom">
            <div class="tf-product-info-list">

              <!-- Heading -->
              <div class="tf-product-heading">
                <div class="row align-items-start">
                  <div class="col-12">

                    {% if p.display_brand %}
                      <span class="brand-product">{{ p.display_brand }}</span>
                    {% elif p.brand %}
                      <span class="brand-product">{{ p.brand.name }}</span>
                    {% endif %}

                    <h5 class="product-name fw-medium">{{ p.title }}</h5>

                    <div class="product-price mt-3">
                      <div class="display-sm price-new price-on-sale">
                        {{ auction.current_price }} RON
                      </div>

                      {% if auction.start_price and auction.current_price != auction.start_price %}
                        <div class="display-sm price-old">{{ auction.start_price }} RON</div>
                      {% endif %}

                      {% if auction.reserve_price %}
                        <span class="badge-sale">Rezervă: {{ auction.reserve_price }} RON</span>
                      {% endif %}
                    </div>

                    <div class="product-stock mt-1">
                      {% if auction.is_live %}
                        <span class="stock in-stock">Licitație activă</span>
                        <span class="text-dark ms-2">Se încheie în: {{ auction.end_time|timeuntil }}</span>
                      {% else %}
                        <span class="stock out-stock">Încheiată</span>
                        <span class="text-dark ms-2">
                          Acum {{ auction.ended_at|default:auction.end_time|timesince }}
                        </span>
                      {% endif %}
                    </div>

                    <div class="product-progress-sale mt-2">
                      <div class="title-hurry-up">
                        <span class="text-primary fw-medium">OFERTĂ</span>
                        {{ auction.bids.count }} {% if auction.bids.count == 1 %}ofertă{% else %}oferte{% endif %} plasate
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              <!-- /Heading -->

              <!-- BID (păstrăm formularul) -->
              <div class="tf-product-total-quantity">
                {% if auction.is_live %}
                  {% if user.is_authenticated %}
                    <form method="post" action="{% url 'auctions:place_bid' auction.pk %}" class="w-100">
                      {% csrf_token %}

                      <div class="group-btn flex-column w-100">
                        {% if bid_form and bid_form.non_field_errors %}
                          <div class="text-danger small mb-2">{{ bid_form.non_field_errors }}</div>
                        {% endif %}

                        {% if bid_form %}
                          <label class="form-label mb-1">Minim: {{ auction.current_price }} RON</label>
                          <div class="d-flex gap-2 align-items-start w-100">
                            {{ bid_form.amount }}
                            <button type="submit" class="tf-btn btn-primary animate-btn w-100">
                              Plasează oferta
                            </button>
                          </div>

                          {% if bid_form.amount.errors %}
                            <div class="text-danger small mt-1">{{ bid_form.amount.errors|join:", " }}</div>
                          {% endif %}
                        {% else %}
                          <div class="alert alert-warning mb-0">Formularul de licitare nu este disponibil.</div>
                        {% endif %}
                      </div>
                    </form>
                  {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="tf-btn btn-primary w-100 animate-btn">
                      Autentifică-te pentru a licita
                    </a>
                  {% endif %}
                {% else %}
                  <div class="alert alert-secondary mb-0">Licitația este încheiată.</div>
                {% endif %}

                {% if user.is_authenticated and user == auction.creator and auction.is_live %}
                  <form method="post" action="{% url 'auctions:close_auction' p.slug %}" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="tf-btn btn-outline-secondary w-100">Închide licitația</button>
                  </form>
                {% endif %}
              </div>
              <!-- /BID -->

              <!-- Variants (culoare + mărime + material) — ca product_detail -->
              <div class="tf-product-variant">

                {% if p.base_color or p.colors.all %}
                <div class="variant-picker-item variant-color">
                  <div class="variant-picker-label">
                    Culoare:
                    <span class="variant-picker-label-value value-currentColor">
                      {% firstof p.real_color_name p.base_color.name p.colors.first.name "—" %}
                    </span>
                  </div>

                  <div class="variant-picker-values">
                    {% if p.base_color %}
                      <div class="hover-tooltip tooltip-bot color-btn active">
                        <span class="check-color" style="background: {{ p.base_color.hex_code|default:'#eee' }};"></span>
                        <span class="tooltip">{% firstof p.real_color_name p.base_color.name %}</span>
                      </div>
                    {% else %}
                      {% for c in p.colors.all|slice:":1" %}
                        <div class="hover-tooltip tooltip-bot color-btn active">
                          <span class="check-color" style="background: {{ c.hex_code|default:'#eee' }};"></span>
                          <span class="tooltip">{% firstof p.real_color_name c.name %}</span>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
                {% endif %}

              </div>
              <!-- /Variants -->

              <!-- SKU & Categories (identic product_detail) -->
              <ul class="tf-product-cate-sku text-md tf-product-heading">
                <li class="item-cate-sku">
                  <span class="label">Mărime:</span>
                  <span class="value">
                    {% if p.shoe_size_eu %}EU {{ p.shoe_size_eu }}
                    {% elif p.size_fr %}FR {{ p.size_fr }}
                    {% elif p.size_it %}IT {{ p.size_it }}
                    {% elif p.size_gb %}GB {{ p.size_gb }}
                    {% else %}{{ p.display_size }}{% endif %}
                  </span>
                </li>

                {% if p.material %}
                <li class="item-cate-sku">
                  <span class="label">Material:</span>
                  <span class="value">{{ p.material.name }}</span>
                </li>
                {% endif %}

                <li class="item-cate-sku">
                  <span class="label">SKU:</span>
                  <span class="value">{{ p.sku }}</span>
                </li>

                <li class="item-cate-sku">
                  <span class="label">Categorie:</span>
                  <span class="value">{{ p.category.name }}</span>
                </li>

                {% if p.subcategory %}
                  <li class="item-cate-sku">
                    <span class="label">Subcategorie:</span>
                    <span class="value">{{ p.subcategory.name }}</span>
                  </li>
                {% endif %}

                {% if p.display_brand %}
                  <li class="item-cate-sku">
                    <span class="label">Brand:</span>
                    <span class="value">{{ p.display_brand }}</span>
                  </li>
                {% elif p.brand %}
                  <li class="item-cate-sku">
                    <span class="label">Brand:</span>
                    <span class="value">{{ p.brand.name }}</span>
                  </li>
                {% endif %}

                <li class="item-cate-sku">
                  <span class="label">Condiție:</span>
                  <span class="value">{{ p.get_condition_display }}</span>
                </li>
              </ul>

              <!-- VÂNDUT DE (în dreapta, ca product_detail.html) -->
              <div class="product-seller d-flex flex-column gap-1 tf-product-heading">
                <span class="text-sm text-main-4 py-3">Vândut de:</span>

                <div class="d-flex align-items-center gap-2">
                  <div class="avatar-seller rounded-circle overflow-hidden">
                    {% if p.owner.profile and p.owner.profile.avatar %}
                      <img src="{{ p.owner.profile.avatar.url }}"
                           alt="{{ p.owner.full_name }}"
                           width="30" height="30" class="img-fluid">
                    {% else %}
                      <img src="{% static 'images/placeholders/avatar-default.png' %}"
                           alt="{{ p.owner.full_name|default:p.owner.email }}"
                           width="30" height="30"
                           class="img-fluid">
                    {% endif %}
                  </div>

                  <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="fw-medium text-md">
                      {{ p.owner.full_name|default:p.owner.email }}
                    </span>

                    {% with sp=p.owner.sellerprofile %}
                      {% if sp %}
                        <span
                          class="ms-1 has-tip"
                          data-bs-toggle="tooltip"
                          data-bs-placement="bottom"
                          data-bs-title="Trust Seller {{ sp.seller_trust_score }}/100 ({{ sp.seller_trust_class }})"
                          aria-label="Trust Seller {{ sp.seller_trust_score }}/100 ({{ sp.seller_trust_class }})"
                          tabindex="0">

                          {% if sp.seller_trust_class == 'A' %}
                            <img src="{% static 'images/badge/trust_seller_a.png' %}"
                                 alt="Trust Seller A"
                                 class="badge-icon">
                          {% elif sp.seller_trust_class == 'B' %}
                            <img src="{% static 'images/badge/trust_seller_b.png' %}"
                                 alt="Trust Seller B"
                                 class="badge-icon">
                          {% elif sp.seller_trust_class == 'C' %}
                            <img src="{% static 'images/badge/trust_seller_c.png' %}"
                                 alt="Trust Seller C"
                                 class="badge-icon">
                          {% else %}
                            <img src="{% static 'images/badge/trust_seller_d.png' %}"
                                 alt="Trust Seller D"
                                 class="badge-icon">
                          {% endif %}
                        </span>
                      {% endif %}
                    {% endwith %}

                    {% with prof=p.owner.profile %}
                      {% if prof.has_kyc_badge %}
                        <span
                          class="badge-icon badge-icon--kyc ms-1 has-tip"
                          data-bs-toggle="tooltip"
                          data-bs-placement="bottom"
                          data-bs-title="KYC verificat"
                          aria-label="KYC verificat"
                          tabindex="0">
                          <img src="{% static 'images/badge/kyc_verified.png' %}"
                               alt="KYC Verified badge"
                               loading="lazy">
                        </span>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              </div>

              <!-- Trust badges -->
              <div class="tf-product-trust-seal text-center">
                <ul class="list-card">
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/Visa.png" alt="Visa"></li>
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/Mastercard.png" alt="Mastercard"></li>
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/Stripe.png" alt="Stripe"></li>
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/PayPal.png" alt="PayPal"></li>
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/ApplePay.png" alt="Apple Pay"></li>
                  <li class="card-item"><img src="https://themesflat.co/html/vineta/images/payment/GooglePay.png" alt="Google Pay"></li>
                </ul>
              </div>

              <!-- Livrare -->
              <div class="tf-product-delivery-return">
                <div class="product-delivery">
                  <div class="icon icon-car2"></div>
                  <p class="text-md">Livrare estimată: <span class="fw-medium">1–3 zile</span></p>
                </div>
                <div class="product-delivery">
                  <div class="icon icon-shipping3"></div>
                  <p class="text-md">Transport gratuit la <span class="fw-medium">comenzi &gt; 700 RON</span></p>
                </div>
              </div>

            </div>
          </div>
        </div>
        <!-- /Info -->

      </div>
    </div>
  </div>
</section>
<!-- /Main -->

<!-- Description / Details -->
<section class="flat-spacing pt-0">
  <div class="container">

    <!-- Descriere -->
    <div class="widget-accordion wd-product-descriptions">
      <div class="accordion-title collapsed" data-bs-target="#description" data-bs-toggle="collapse"
           aria-expanded="true" aria-controls="description" role="button">
        <span>Descriere</span>
        <span class="icon icon-arrow-down"></span>
      </div>
      <div id="description" class="collapse">
        <div class="accordion-body widget-desc">
          {% if auction.description %}
            <div class="item">
              <p class="mb-0">{{ auction.description|linebreaksbr }}</p>
            </div>
          {% elif p.description %}
            <div class="item">
              <p class="mb-0">{{ p.description|linebreaksbr }}</p>
            </div>
          {% endif %}

          <div class="item">
            <p class="fw-medium title mb-2">Detalii licitație</p>
            <ul class="mb-0">
              {% if auction.start_price %}<li>Preț start: <strong>{{ auction.start_price }} RON</strong></li>{% endif %}
              <li>Preț curent: <strong>{{ auction.current_price }} RON</strong></li>
              {% if auction.reserve_price %}<li>Rezervă: <strong>{{ auction.reserve_price }} RON</strong></li>{% endif %}
              <li>Oferte: <strong>{{ auction.bids.count }}</strong></li>
              <li>Se încheie la: <strong>{{ auction.end_time|date:"d.m.Y H:i" }}</strong></li>
              <li>Status: <strong>{% if auction.is_live %}Activă{% else %}Încheiată{% endif %}</strong></li>
            </ul>
          </div>

          {% if auction.dimensions %}
            <div class="item">
              <p class="fw-medium title">Măsuri</p>
              <ul class="mb-0">
                {% for k,v in auction.dimensions.items %}
                  <li>{{ k }}: {{ v }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Informații suplimentare -->
    <div class="widget-accordion wd-product-descriptions">
      <div class="accordion-title collapsed" data-bs-target="#addInformation" data-bs-toggle="collapse"
           aria-expanded="true" aria-controls="addInformation" role="button">
        <span>Informații suplimentare</span>
        <span class="icon icon-arrow-down"></span>
      </div>
      <div id="addInformation" class="collapse">
        <div class="accordion-body">
          <table class="tb-info-product text-md">
            <tbody>

              {% if p.material %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Material</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.material.name }}</p></td>
              </tr>
              {% endif %}

              {% if p.real_color_name or p.base_color %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Culoare</th>
                <td class="tb-attr-value">
                  <p class="mb-0">
                    {% if p.real_color_name %}
                      {{ p.real_color_name }}
                      {% if p.base_color and p.base_color.name and p.base_color.name != p.real_color_name %}
                        ({{ p.base_color.name }})
                      {% endif %}
                    {% else %}
                      {{ p.base_color.name }}
                    {% endif %}
                  </p>
                </td>
              </tr>
              {% endif %}

              {% if p.display_brand %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Brand</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.display_brand }}</p></td>
              </tr>
              {% elif p.brand %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Brand</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.brand.name }}</p></td>
              </tr>
              {% endif %}

              <tr class="tb-attr-item">
                <th class="tb-attr-label">Categorie</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.category.name }}</p></td>
              </tr>

              {% if p.subcategory %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Subcategorie</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.subcategory.get_breadcrumb }}</p></td>
              </tr>
              {% endif %}

              <tr class="tb-attr-item">
                <th class="tb-attr-label">Mărime</th>
                <td class="tb-attr-value">
                  <p class="mb-0">
                    {% if p.shoe_size_eu %}EU {{ p.shoe_size_eu }}
                    {% elif p.size_fr %}FR {{ p.size_fr }}
                    {% elif p.size_it %}IT {{ p.size_it }}
                    {% elif p.size_gb %}GB {{ p.size_gb }}
                    {% else %}{{ p.display_size }}{% endif %}
                  </p>
                </td>
              </tr>

              <tr class="tb-attr-item">
                <th class="tb-attr-label">Condiție</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.get_condition_display }}</p></td>
              </tr>

              {% if p.condition_notes %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Detalii condiție</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.condition_notes }}</p></td>
              </tr>
              {% endif %}

              {% if p.get_gender_display %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Gen</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.get_gender_display }}</p></td>
              </tr>
              {% endif %}

              {% if p.package_size %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Dimensiune colet</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.get_package_size_display }}</p></td>
              </tr>
              {% endif %}

              {% if p.weight_g %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Greutate</th>
                <td class="tb-attr-value"><p class="mb-0">{{ p.weight_g }} g</p></td>
              </tr>
              {% endif %}

              {% if p.pickup_location %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Locație ridicare</th>
                <td class="tb-attr-value">
                  <p class="mb-0">{% firstof p.pickup_location.label p.pickup_location.code "—" %}</p>
                </td>
              </tr>
              {% endif %}

              {% if p.sustainability_none or p.sustainability_tags.all %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Sustenabilitate</th>
                <td class="tb-attr-value">
                  <p class="mb-0">
                    {% if p.sustainability_none %}
                      Nici una
                    {% else %}
                      {% for tag in p.sustainability_tags.all %}
                        {{ tag.name }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                    {% endif %}
                  </p>
                </td>
              </tr>
              {% endif %}

              {% if p.subcategory and p.subcategory.is_non_returnable %}
              <tr class="tb-attr-item">
                <th class="tb-attr-label">Retur</th>
                <td class="tb-attr-value"><p class="mb-0">Nereturnabil (categorie specială)</p></td>
              </tr>
              {% endif %}

            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Informații vânzător (detaliat) -->
    <div class="widget-accordion wd-product-descriptions">
      <div class="accordion-title collapsed" data-bs-target="#sellerInfo" data-bs-toggle="collapse"
           aria-expanded="true" aria-controls="sellerInfo" role="button">
        <span>Informații vânzător</span>
        <span class="icon icon-arrow-down"></span>
      </div>
      <div id="sellerInfo" class="collapse">
        <div class="accordion-body wd-customer-review">
          <div class="review-heading">
            <h6 class="title">Despre vânzător</h6>
          </div>

          <div class="seller-info">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="avatar-seller rounded-circle overflow-hidden">
                {% if p.owner.profile and p.owner.profile.avatar %}
                  <img src="{{ p.owner.profile.avatar.url }}"
                       alt="{{ p.owner.full_name }}"
                       width="60" height="60" class="img-fluid">
                {% else %}
                  <img src="{% static 'images/placeholders/avatar-default.png' %}"
                       alt="{{ p.owner.full_name|default:p.owner.email }}"
                       width="60" height="60" class="img-fluid">
                {% endif %}
              </div>

              <div>
                <div class="fw-medium text-md mb-1">
                  {{ p.owner.full_name|default:p.owner.email }}
                </div>

                {% with sp=p.owner.sellerprofile %}
                  {% if sp %}
                    <div class="text-sm text-main-4 mb-1">
                      {{ sp.get_seller_type_display }} · {{ sp.get_seller_level_display }}
                      {% if sp.has_kyc_badge %}
                        <span class="badge bg-success ms-1">KYC</span>
                      {% endif %}
                    </div>
                    <div class="text-sm text-main-4">
                      Trust score: {{ sp.seller_trust_score }}/100
                      <span class="hover-tooltip"
                            data-bs-toggle="tooltip"
                            title="A = foarte de încredere, D = risc ridicat.">
                        (Clasă {{ sp.seller_trust_class }})
                        <span class="tooltip">Scor calculat automat din istoricul de vânzări.</span>
                      </span>
                    </div>
                  {% endif %}
                {% endwith %}
              </div>
            </div>

            {% with sp=p.owner.sellerprofile %}
            <ul class="list-unstyled text-sm text-main-4 mb-0">
              <li><strong>Membru din:</strong> {{ p.owner.date_joined|date:"d.m.Y" }}</li>
              {% if sp and sp.default_location %}
                <li><strong>Locație principală:</strong> {{ sp.default_location.label|default:sp.default_location.code }}</li>
              {% endif %}
              <li><strong>Anunțuri postate:</strong> {{ p.owner.products.all|length }}</li>
            </ul>
            {% endwith %}
          </div>
        </div>
      </div>
    </div>

    <!-- Oferte recente -->
    <div class="widget-accordion wd-product-descriptions">
      <div class="accordion-title collapsed" data-bs-target="#bids" data-bs-toggle="collapse"
           aria-expanded="true" aria-controls="bids" role="button">
        <span>Oferte recente</span>
        <span class="icon icon-arrow-down"></span>
      </div>
      <div id="bids" class="collapse">
        <div class="accordion-body">
          {% if auction.bids.count %}
            <ul class="list-unstyled">
              {% for b in auction.bids.all|slice:":10" %}
                <li class="py-2 d-flex justify-content-between border-bottom">
                  <span>{{ b.user }}</span>
                  <span><strong>{{ b.amount }} RON</strong> · <small class="text-muted">{{ b.placed_at|timesince }} în urmă</small></span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Încă nu există oferte. Fii primul!</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</section>
<!-- /Description / Details -->

<!-- === INIT SWIPER PENTRU GALLERY === -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof Swiper === 'undefined') {
      console.warn('Swiper JS nu este încărcat.');
      return;
    }

    // Thumbs
    var thumbsSwiper = new Swiper('.tf-product-media-thumbs', {
      spaceBetween: 8,
      slidesPerView: 4,
      direction: 'vertical',
      watchSlidesProgress: true,
      watchSlidesVisibility: true,
      freeMode: true,
      breakpoints: {
        0: { direction: 'horizontal' },
        768: { direction: 'vertical' }
      }
    });

    // Main gallery
    var mainSwiper = new Swiper('#gallery-swiper-started', {
      spaceBetween: 10,
      navigation: {
        nextEl: '.thumbs-next',
        prevEl: '.thumbs-prev',
      },
      thumbs: { swiper: thumbsSwiper }
    });
  });
</script>
<!-- /INIT SWIPER -->

{% endwith %} {# first_extra #}
{% endwith %} {# p #}

{% endblock %}
