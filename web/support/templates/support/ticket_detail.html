{# templates/support/ticket_detail.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ticket #{{ ticket.id }} – Snobistic{% endblock %}

{% block content %}

<style>
  /* Support Ticket Detail – similar cu account/dashboard + messaging */

  .support-topbar {
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    border: 1px solid rgba(15, 23, 42, 0.04);
    background: #fff;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.04);
  }

  .support-back {
    text-decoration: none;
    color: #111827;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
  }
  .support-back:hover { text-decoration: underline; }

  .support-title { margin: 0; font-size: 1.1rem; }
  .support-sub { color: #6b7280; font-size: 0.88rem; }

  .support-card {
    padding: 1.25rem 1.5rem;
    border-radius: 16px;
    border: 1px solid rgba(15, 23, 42, 0.06);
    background: #fff;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.04);
  }

  .support-meta {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem .65rem;
    align-items: center;
  }
  .support-pill {
    border-radius: 999px;
    border: 1px solid rgba(15, 23, 42, 0.10);
    padding: .35rem .7rem;
    background: rgba(15, 23, 42, 0.02);
    font-size: .82rem;
    color: #111827;
  }

  .support-thread {
    border-radius: 16px;
    border: 1px solid rgba(15, 23, 42, 0.06);
    background: #fff;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.04);
    overflow: hidden;
  }
  .support-thread-header {
    padding: .85rem 1rem;
    border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    background: rgba(15, 23, 42, 0.02);
  }
  .support-thread-body {
    padding: 1rem;
  }

  .support-composer {
    padding: .9rem 1rem;
    border-top: 1px solid rgba(15, 23, 42, 0.06);
    background: #fff;
  }

  .support-form textarea,
  .support-form input,
  .support-form select {
    width: 100%;
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.12);
    padding: .65rem .85rem;
    outline: none;
    background: #fff;
    font-size: 0.92rem;
  }
  .support-form textarea { min-height: 120px; }
  .support-form textarea:focus,
  .support-form input:focus,
  .support-form select:focus {
    border-color: rgba(37, 99, 235, 0.35);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.10);
  }

  .support-actions .tf-btn { white-space: nowrap; }

  .support-order-card {
    border-radius: 16px;
    border: 1px solid rgba(15, 23, 42, 0.06);
    background: rgba(15, 23, 42, 0.02);
    padding: 1rem 1.1rem;
  }

  .support-section-title {
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #9ca3af;
  }
</style>

<section class="tf-page-title">
  <div class="container">
    <div class="box-title text-center">
      <h4 class="title">Ticket #{{ ticket.id }}</h4>
      <div class="breadcrumb-list">
        <a class="breadcrumb-item" href="{% url 'core:home' %}">Acasă</a>
        <div class="breadcrumb-item dot"><span></span></div>
        <a class="breadcrumb-item" href="{% url 'support:tickets_list' %}">Suport</a>
        <div class="breadcrumb-item dot"><span></span></div>
        <div class="breadcrumb-item current">Ticket #{{ ticket.id }}</div>
      </div>
    </div>
  </div>
</section>

<div class="flat-spacing-13">
  <div class="container-7">

    <div class="support-topbar mb-3">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3">
        <div>
          <a href="{% url 'support:tickets_list' %}" class="support-back mb-2">
            <span aria-hidden="true">←</span> Înapoi la solicitări
          </a>

          <h2 class="support-title">#{{ ticket.id }} – {{ ticket.subject }}</h2>
          <div class="support-sub">
            Ultima actualizare: {{ ticket.updated_at|date:"d.m.Y H:i" }}
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 align-items-center support-actions">
          <a class="tf-btn animate-btn" href="{% url 'support:ticket_open_chat' ticket.id %}">
            Deschide chat suport
          </a>

          {# ✅ FIX: în template folosim perms, nu user.has_perm(...) #}
          {% if request.user.is_staff or perms.support.change_ticket %}
            <a class="tf-btn btn-out-line-dark" href="{% url 'support:ticket_update' ticket.id %}">
              Editează ticket
            </a>
          {% endif %}

          <a class="tf-btn btn-out-line-dark" href="{% url 'support:tickets_list' %}">
            Toate tichetele
          </a>
        </div>
      </div>

      <hr class="my-3">

      <div class="support-meta">
        <span class="support-pill">Status: <strong>{{ ticket.get_status_display }}</strong></span>
        <span class="support-pill">Prioritate: <strong>{{ ticket.get_priority_display }}</strong></span>
        <span class="support-pill">Categorie: <strong>{{ ticket.get_category_display }}</strong></span>
        <span class="support-pill">Creat: <strong>{{ ticket.created_at|date:"d.m.Y H:i" }}</strong></span>
      </div>
    </div>

    {% if ticket.order %}
      <div class="support-card mb-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
          <div>
            <div class="support-section-title mb-2">Comandă asociată</div>
            <div class="support-order-card">
              <div class="mb-1">
                <strong>Comanda:</strong>
                <a class="text-decoration-underline" href="{% url 'orders:order_detail' ticket.order.id %}">
                  #{{ ticket.order.id }}
                </a>
                <span class="text-muted">· total {{ ticket.order.total }} RON</span>
              </div>

              <div class="text-sm text-muted">
                Status plată: {{ ticket.order.payment_status_label }} ·
                Livrare: {{ ticket.order.get_shipping_status_display }} ·
                Escrow: {{ ticket.order.escrow_status_label }}
              </div>
            </div>
          </div>

          <div class="text-md-end">
            <a class="tf-btn btn-out-line-dark" href="{% url 'orders:order_detail' ticket.order.id %}">
              Vezi comanda
            </a>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="support-thread">
      <div class="support-thread-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span class="badge rounded-pill bg-light text-dark text-xxs px-3 py-1">Conversație tichet</span>
          {% if ticket.is_closed %}
            <span class="badge rounded-pill bg-secondary text-xxs px-3 py-1">închis</span>
          {% endif %}
        </div>
        <div class="text-xxs text-grey">
          Mesaje: {{ messages|length }}
        </div>
      </div>

      <div class="support-thread-body">
        {% if ticket.description %}
          <div class="support-card mb-3" style="box-shadow:none;">
            <div class="support-section-title mb-2">Descriere inițială</div>
            <div class="text-sm">{{ ticket.description|linebreaksbr }}</div>
          </div>
        {% endif %}

        <div class="mb-3">
          {% for msg in messages %}
            {% include "support/partials/message_bubble.html" with message=msg %}
          {% empty %}
            <div class="text-muted">
              Nu există mesaje încă. Trimite primul mesaj mai jos.
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="support-composer">
        <div class="support-section-title mb-2">Răspunde</div>

        <form method="post" class="support-form">
          {% csrf_token %}
          {% include "support/partials/form_errors.html" with form=msg_form %}

          {{ msg_form.as_p }}

          <div class="d-flex flex-column flex-sm-row gap-2 justify-content-end mt-2">
            <button class="tf-btn animate-btn" type="submit">
              Trimite mesaj
            </button>
          </div>
        </form>

        <div class="mt-2 text-xxs text-grey">
          Tip: cu cât dai mai multe detalii (pași, capturi, ID comandă), cu atât rezolvăm mai rapid.
        </div>
      </div>
    </div>

  </div>
</div>

{% endblock %}
